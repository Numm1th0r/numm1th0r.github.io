<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT Looper Pro - Auto Title</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #181818;
            --bg-light: #282828;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --accent: #1db954;
            --loop-color: #ff4081; 
            --timeline-bg: #535353;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: grid;
            grid-template-rows: 1fr 160px;
            overflow: hidden;
        }

        /* --- F≈ë elrendez√©s --- */
        .main-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            overflow: hidden;
            height: 100%;
        }

        /* --- Oldals√°v --- */
        .sidebar {
            background-color: black;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-right: 1px solid #333;
            overflow-y: auto;
        }

        .sidebar h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-sub); margin-bottom: 5px; }
        
        .group-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-sub);
            transition: 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        .group-item:hover { color: white; background: #222; }
        .group-item.active { background-color: var(--bg-light); color: white; border-left: 3px solid var(--accent); }
        
        .sidebar-btn {
            background: transparent; border: 1px solid #444; color: var(--text-sub);
            padding: 8px; cursor: pointer; border-radius: 4px; margin-top: 5px; font-size: 12px;
            transition: 0.2s; text-align: center;
        }
        .sidebar-btn:hover { border-color: white; color: white; }
        .sidebar-btn.primary { background: var(--text-main); color: black; border: none; font-weight: bold; }
        .sidebar-btn.primary:hover { background: #ddd; }

        #file-input { display: none; }

        /* --- Tartalom --- */
        .content-area {
            background: linear-gradient(to bottom, #2a2a2a, #121212);
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .video-container {
            width: 100%;
            max-width: 700px;
            aspect-ratio: 16 / 9;
            background: #000;
            margin: 0 auto 20px auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; 
        }
        
        .video-container iframe { width: 100%; height: 100%; border: none; }

        .header-controls { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;}
        
        .import-area { display: flex; gap: 10px; margin-bottom: 20px; }
        .import-area input {
            flex: 1; background: var(--bg-light); border: 1px solid #444; color: white; padding: 10px;
            border-radius: 4px;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: var(--text-sub); border-bottom: 1px solid #333; padding: 10px; font-weight: normal; font-size: 12px;}
        td { padding: 12px 10px; border-bottom: 1px solid #222; }
        tr:hover { background-color: rgba(255,255,255,0.05); }
        
        .action-btn {
            background: transparent; border: 1px solid #555; color: white; 
            cursor: pointer; font-size: 11px; padding: 4px 8px; border-radius: 4px;
        }
        .action-btn:hover { border-color: white; }
        .btn-delete { border-color: #555; color: #ff5555; }
        .btn-delete:hover { border-color: #ff5555; background: rgba(255, 85, 85, 0.1); }

        /* --- Lej√°tsz√≥ S√°v --- */
        .player-bar {
            background-color: var(--bg-panel);
            border-top: 1px solid #333;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            z-index: 10;
        }

        .video-info { overflow: hidden; white-space: nowrap; padding-right: 10px;}
        .video-title { display: block; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; color: white; font-weight: bold;}
        .video-time { color: var(--accent); font-family: monospace; font-size: 14px; }

        .player-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .timeline-container {
            width: 100%;
            height: 6px;
            position: relative;
            background: var(--timeline-bg);
            border-radius: 3px;
            cursor: pointer;
        }

        .loop-region {
            position: absolute; height: 100%; background: var(--loop-color);
            opacity: 0.6; border-radius: 3px; pointer-events: none;
            transition: all 0.2s;
        }
        .play-progress {
            position: absolute; height: 100%; background: white;
            border-radius: 3px; pointer-events: none; width: 0%;
        }

        .ab-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #222;
            padding: 8px 20px;
            border-radius: 30px;
            border: 1px solid #333;
        }

        .ab-btn {
            background: #333; border: 1px solid #555; color: #ccc;
            padding: 5px 12px; border-radius: 4px; cursor: pointer;
            font-size: 12px; font-family: monospace; display: flex; flex-direction: column; align-items: center;
            min-width: 60px;
        }
        .ab-btn:hover { background: #444; color: white; border-color: #888; }
        .ab-btn.set { border-color: var(--loop-color); color: var(--loop-color); background: rgba(255, 64, 129, 0.1); }
        .ab-btn span { font-size: 10px; color: #888; margin-top: 2px;}
        .ab-btn.set span { color: var(--loop-color); }

        .btn-circle {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; background: white; color: black;
            transition: transform 0.2s;
        }
        .btn-circle:hover { transform: scale(1.1); }
        
        .btn-clear { background: transparent; border: none; color: #666; font-size: 18px; cursor: pointer; }
        .btn-clear:hover { color: #ff5555; }

        .player-right { display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        .speed-btn { background: transparent; border: none; color: #aaa; cursor: pointer; font-size: 18px; }
        .speed-val { font-family: monospace; width: 40px; text-align: center; font-size: 14px; }

        /* T√∂lt√©s jelz≈ë */
        .loading-spinner {
            display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <h2 style="font-size:16px; color:white; margin-bottom: 20px;">My Loops</h2>
            
            <button class="sidebar-btn primary" onclick="createNewGroup()">+ √öj Csoport</button>
            
            <div style="flex-grow: 1; overflow-y: auto; margin-top:10px;" id="group-list"></div>

            <div style="border-top: 1px solid #333; padding-top: 10px; margin-top: 10px;">
                <h2>Adatb√°zis</h2>
                <button class="sidebar-btn" style="width:100%" onclick="saveToFile()">üíæ Ment√©s F√°jlba (TXT)</button>
                <button class="sidebar-btn" style="width:100%" onclick="document.getElementById('file-input').click()">üìÇ Bet√∂lt√©s F√°jlb√≥l</button>
                <input type="file" id="file-input" accept=".txt,.json" onchange="loadFromFile(this)">
            </div>
        </div>

        <div class="content-area">
            
            <div id="video-wrapper" class="video-container">
                <div id="player"></div>
            </div>

            <div class="header-controls">
                <h1 id="current-group-title" style="margin:0; font-size: 22px;">K√∂nyvt√°r</h1>
            </div>

            <div class="import-area">
                <input type="text" id="import-url" placeholder="YouTube Link (pl. https://www.youtube.com/watch?v=...)" onkeydown="if(event.key==='Enter') addVideo()">
                <button class="sidebar-btn primary" onclick="addVideo()">Hozz√°ad</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th>Vide√≥ C√≠me</th>
                        <th style="width: 140px; text-align:right;">Kezel√©s</th>
                    </tr>
                </thead>
                <tbody id="video-list-body"></tbody>
            </table>
        </div>
    </div>

    <div class="player-bar">
        
        <div class="video-info">
            <div class="video-title" id="now-playing-title">Nincs vide√≥</div>
            <div class="video-time" id="time-display">00:00 / 00:00</div>
        </div>

        <div class="player-center">
            
            <div class="timeline-container" id="timeline" onclick="seekClick(event)">
                <div class="loop-region" id="loop-region" style="left: 0%; width: 0%; display:none;"></div>
                <div class="play-progress" id="play-progress"></div>
            </div>

            <div class="ab-controls">
                <button class="ab-btn" id="btn-a" onclick="setA()">SET A<span id="label-a">--:--</span></button>
                <button class="ab-btn" id="btn-b" onclick="setB()">SET B<span id="label-b">--:--</span></button>
                <button class="btn-clear" onclick="clearLoop()" title="Loop T√∂rl√©se">‚úï</button>
                <div style="width: 1px; height: 20px; background: #444; margin: 0 10px;"></div>
                
                <button class="speed-btn" onclick="skip(-5)">‚Ü∫</button>
                <button class="btn-circle" onclick="togglePlay()"><span id="play-icon">‚ñ∂</span></button>
                <button class="speed-btn" onclick="skip(5)">‚Üª</button>
            </div>
            
            <div style="font-size: 11px; color: #666; margin-top: 5px;">
                <label><input type="checkbox" id="chk-loop" checked> Automatikus Loop</label>
            </div>
        </div>

        <div class="player-right">
            <button class="speed-btn" onclick="changeSpeed(-0.1)">-</button>
            <span class="speed-val" id="speed-val">1.0</span>
            <button class="speed-btn" onclick="changeSpeed(0.1)">+</button>
        </div>
    </div>

    <script>
        // --- Adatstrukt√∫ra ---
        let groups = [ { id: 1, name: 'Kezd≈ë Lista', videos: [] } ];
        let currentGroupId = 1;
        let player, duration = 0, loopStart = null, loopEnd = null, updateInterval;

        window.onload = function() {
            loadFromLocalStorage();
            renderGroups();
            renderVideos();
        };

        // --- YouTube API ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady(event) { updateInterval = setInterval(loopLogic, 100); }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                document.getElementById('play-icon').innerHTML = "‚ùö‚ùö";
                document.getElementById('video-wrapper').style.display = "block";
                duration = player.getDuration();
                
                // Ha m√©g nincs c√≠me a vide√≥nak (pl. hiba volt importkor), pr√≥b√°ljuk meg a playerb≈ël friss√≠teni
                tryUpdateCurrentVideoTitle();
            } else {
                document.getElementById('play-icon').innerHTML = "‚ñ∂";
            }
        }

        function loopLogic() {
            if (!player || !player.getCurrentTime) return;
            const ct = player.getCurrentTime();
            if(duration > 0) {
                document.getElementById('time-display').innerText = formatTime(ct) + " / " + formatTime(duration);
                document.getElementById('play-progress').style.width = ((ct / duration) * 100) + "%";
            }
            const autoLoop = document.getElementById('chk-loop').checked;
            if (autoLoop && loopStart !== null && loopEnd !== null) {
                if (ct >= loopEnd || (ct < loopStart && Math.abs(ct-loopStart) > 2)) {
                    player.seekTo(loopStart);
                }
            }
        }

        // --- C√≠m Lek√©r√©s Logika (NoEmbed) ---
        async function fetchVideoTitle(url) {
            try {
                // A noembed szolg√°ltat√°s ingyenes √©s nem k√©r API kulcsot
                const response = await fetch(`https://noembed.com/embed?url=${url}`);
                const data = await response.json();
                if (data.title) {
                    return data.title;
                }
                return null;
            } catch (error) {
                console.error("C√≠m lek√©r√©si hiba:", error);
                return null;
            }
        }

        function tryUpdateCurrentVideoTitle() {
            if(!player || !player.getVideoData) return;
            const data = player.getVideoData();
            if(data && data.title) {
                const group = groups.find(g => g.id === currentGroupId);
                const currentVideoId = data.video_id;
                const vid = group.videos.find(v => v.id === currentVideoId);
                
                // Ha a c√≠m placeholder vagy az ID, cser√©lj√ºk le a sz√©p c√≠mre
                if(vid && (vid.title.includes('Vide√≥ (') || vid.title === 'C√≠m bet√∂lt√©se...')) {
                    vid.title = data.title;
                    saveToLocalStorage();
                    renderVideos();
                    document.getElementById('now-playing-title').innerText = data.title;
                }
            }
        }

        // --- Hozz√°ad√°s Logika ---
        async function addVideo() {
            const urlInput = document.getElementById('import-url');
            const url = urlInput.value;
            const id = extractVideoID(url);
            
            if(id) {
                const group = groups.find(g => g.id === currentGroupId);
                
                // Ideiglenes objektum
                const newVideo = { 
                    id: id, 
                    title: "C√≠m bet√∂lt√©se...", 
                    addedAt: Date.now() 
                };
                
                group.videos.push(newVideo);
                urlInput.value = '';
                renderVideos(); // Azonnal mutatjuk a list√°ban "Bet√∂lt√©s..."-sel
                
                // H√°tt√©rben lek√©rj√ºk a c√≠met
                const realTitle = await fetchVideoTitle(url);
                
                // Megkeress√ºk √©s friss√≠tj√ºk
                const vidToUpdate = group.videos.find(v => v.addedAt === newVideo.addedAt);
                if(vidToUpdate) {
                    vidToUpdate.title = realTitle ? realTitle : `Vide√≥ (${id})`;
                    saveToLocalStorage();
                    renderVideos(); // √öjrarenderelj√ºk a val√≥di c√≠mmel
                }
            } else {
                alert("Hib√°s YouTube link!");
            }
        }

        // --- Egy√©b Vez√©rl≈ëk ---
        function setA() { if(!player) return; loopStart = player.getCurrentTime(); updateLoopVisuals(); }
        function setB() { if(!player) return; loopEnd = player.getCurrentTime(); if (loopStart !== null && loopEnd < loopStart) loopStart = 0; updateLoopVisuals(); }
        function clearLoop() { loopStart = null; loopEnd = null; updateLoopVisuals(); }

        function updateLoopVisuals() {
            const region = document.getElementById('loop-region');
            const btnA = document.getElementById('btn-a'); const lblA = document.getElementById('label-a');
            const btnB = document.getElementById('btn-b'); const lblB = document.getElementById('label-b');

            if (loopStart !== null) { btnA.classList.add('set'); lblA.innerText = formatTime(loopStart); } 
            else { btnA.classList.remove('set'); lblA.innerText = "--:--"; }

            if (loopEnd !== null) { btnB.classList.add('set'); lblB.innerText = formatTime(loopEnd); } 
            else { btnB.classList.remove('set'); lblB.innerText = "--:--"; }

            if (loopStart !== null && loopEnd !== null && duration > 0) {
                region.style.display = "block";
                region.style.left = (loopStart/duration)*100 + "%";
                region.style.width = ((loopEnd-loopStart)/duration)*100 + "%";
            } else { region.style.display = "none"; }
        }

        function playVideo(id, title) {
            player.loadVideoById(id);
            document.getElementById('now-playing-title').innerText = title;
            clearLoop();
        }

        function seekClick(e) {
            if (!player || duration === 0) return;
            const rect = e.currentTarget.getBoundingClientRect();
            player.seekTo(((e.clientX - rect.left) / rect.width) * duration);
        }

        function deleteVideo(idx) {
            if(confirm("T√∂rl√∂d a vide√≥t?")) {
                const group = groups.find(g => g.id === currentGroupId);
                group.videos.splice(idx, 1);
                saveToLocalStorage();
                renderVideos();
            }
        }

        function createNewGroup() {
            const name = prompt("Csoport neve:");
            if(name) {
                groups.push({ id: Date.now(), name: name, videos: [] });
                saveToLocalStorage();
                renderGroups();
            }
        }

        function renderGroups() {
            const list = document.getElementById('group-list'); list.innerHTML = '';
            groups.forEach(g => {
                const div = document.createElement('div');
                div.className = `group-item ${g.id === currentGroupId ? 'active' : ''}`;
                div.innerText = g.name;
                div.onclick = () => { currentGroupId = g.id; renderGroups(); renderVideos(); };
                list.appendChild(div);
            });
            document.getElementById('current-group-title').innerText = groups.find(g => g.id === currentGroupId)?.name || 'K√∂nyvt√°r';
        }

        function renderVideos() {
            const tbody = document.getElementById('video-list-body'); tbody.innerHTML = '';
            const group = groups.find(g => g.id === currentGroupId);
            if(!group) return;
            group.videos.forEach((vid, idx) => {
                const tr = document.createElement('tr');
                // Ha √©ppen t√∂lt, tesz√ºnk mell√© egy kis anim√°ci√≥t vagy jelz√©st
                const titleDisplay = vid.title === "C√≠m bet√∂lt√©se..." ? 
                    `<span style="color:#888">‚è≥ ${vid.title}</span>` : vid.title;

                tr.innerHTML = `
                    <td style="color:#666">${idx+1}</td>
                    <td>${titleDisplay}</td>
                    <td style="text-align:right;">
                        <button class="action-btn" onclick="playVideo('${vid.id}', '${vid.title.replace(/'/g, "\\'")}')">Lej√°tsz√°s</button>
                        <button class="action-btn btn-delete" onclick="deleteVideo(${idx})">T√∂rl√©s</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Save / Load ---
        function saveToLocalStorage() { localStorage.setItem('yt_looper_data_v4', JSON.stringify(groups)); }
        function loadFromLocalStorage() {
            const data = localStorage.getItem('yt_looper_data_v4');
            if(data) try { groups = JSON.parse(data); } catch(e) {}
        }
        function saveToFile() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(groups, null, 2)], { type: "text/plain" }));
            a.download = "youtube_csoportok.txt";
            a.click();
        }
        function loadFromFile(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { groups = JSON.parse(e.target.result); saveToLocalStorage(); renderGroups(); renderVideos(); alert("Sikeres bet√∂lt√©s!"); } 
                catch(err) { alert("Hiba a f√°jlban!"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function extractVideoID(url) {
            var match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length == 11) ? match[2] : null;
        }
        function formatTime(s) { if(isNaN(s)) return "00:00"; const m = Math.floor(s/60), sec = Math.floor(s%60); return (m<10?"0"+m:m) + ":" + (sec<10?"0"+sec:sec); }
        function changeSpeed(d) { let n = Math.round((Math.max(0.25, Math.min(2.0, player.getPlaybackRate() + d)))*100)/100; player.setPlaybackRate(n); document.getElementById('speed-val').innerText = n; }
        function skip(s) { player.seekTo(player.getCurrentTime() + s); }
        function togglePlay() { if(player.getPlayerState()===1) player.pauseVideo(); else player.playVideo(); }

    </script>
</body>
</html>
