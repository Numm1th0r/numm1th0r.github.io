<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT Looper Pro - AutoSave</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-panel: #161b22;
            --bg-light: #21262d;
            --text-main: #c9d1d9;
            --text-sub: #8b949e;
            --accent: #238636;
            --accent-hover: #2ea043;
            --loop-color: #f78166; 
            --timeline-bg: #30363d;
            --border: #30363d;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: grid;
            grid-template-rows: 1fr 160px;
            overflow: hidden;
        }

        .main-container { display: grid; grid-template-columns: 260px 1fr; overflow: hidden; height: 100%; }

        .sidebar {
            background-color: var(--bg-panel); padding: 20px; display: flex; flex-direction: column;
            gap: 10px; border-right: 1px solid var(--border); overflow-y: auto;
        }
        .sidebar h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-sub); margin-bottom: 5px; }
        
        .group-item {
            padding: 10px; cursor: pointer; border-radius: 6px; color: var(--text-sub); transition: 0.2s; font-size: 14px; font-weight: 500;
        }
        .group-item:hover { color: var(--text-main); background: var(--bg-light); }
        .group-item.active { background-color: var(--bg-light); color: var(--text-main); border-left: 3px solid var(--accent); }
        
        .sidebar-btn {
            background: var(--bg-light); border: 1px solid var(--border); color: var(--text-main);
            padding: 8px; cursor: pointer; border-radius: 6px; margin-top: 5px; font-size: 13px;
            transition: 0.2s; text-align: center; width: 100%; box-sizing: border-box;
        }
        .sidebar-btn:hover { border-color: var(--text-sub); background: #30363d; }
        .sidebar-btn.primary { background: var(--accent); color: white; border: none; font-weight: bold; }
        .sidebar-btn.primary:hover { background: var(--accent-hover); }

        .sync-status { font-size: 11px; margin-top: 5px; text-align: center; color: var(--text-sub); transition: color 0.5s; }

        .content-area { padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

        .video-container {
            width: 100%; max-width: 700px; aspect-ratio: 16 / 9; background: #000;
            margin: 0 auto 20px auto; border-radius: 8px; overflow: hidden; display: none; 
        }
        .video-container iframe { width: 100%; height: 100%; border: none; }

        .header-controls { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        
        .import-area { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-start; }
        .import-area textarea {
            flex: 1; background: var(--bg-dark); border: 1px solid var(--border); color: white; padding: 10px;
            border-radius: 6px; resize: vertical; min-height: 38px; font-family: inherit;
        }
        .import-area textarea:focus { border-color: var(--text-sub); outline: none; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: var(--text-sub); border-bottom: 1px solid var(--border); padding: 10px; font-weight: normal; font-size: 12px;}
        td { padding: 12px 10px; border-bottom: 1px solid var(--bg-light); }
        tr:hover { background-color: var(--bg-light); }
        
        .action-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-main); 
            cursor: pointer; font-size: 11px; padding: 4px 8px; border-radius: 4px;
        }
        .action-btn:hover { border-color: var(--text-sub); }
        .btn-delete { border-color: #3d1c1c; color: #ff5555; }
        .btn-delete:hover { border-color: #ff5555; background: rgba(255, 85, 85, 0.1); }

        .player-bar {
            background-color: var(--bg-panel); border-top: 1px solid var(--border); padding: 0 20px;
            display: grid; grid-template-columns: 1fr 2fr 1fr; align-items: center; z-index: 10;
        }

        .video-info { overflow: hidden; white-space: nowrap; padding-right: 10px;}
        .video-title { display: block; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; color: var(--text-main); font-weight: bold;}
        .video-time { color: var(--accent); font-family: monospace; font-size: 14px; }

        .player-center { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }

        .timeline-container {
            width: 100%; height: 6px; position: relative; background: var(--timeline-bg); border-radius: 3px; cursor: pointer;
        }
        .loop-region {
            position: absolute; height: 100%; background: var(--loop-color); opacity: 0.6; border-radius: 3px; pointer-events: none;
        }
        .play-progress {
            position: absolute; height: 100%; background: white; border-radius: 3px; pointer-events: none; width: 0%;
        }

        .ab-controls {
            display: flex; align-items: center; gap: 15px; background: var(--bg-dark);
            padding: 8px 20px; border-radius: 30px; border: 1px solid var(--border);
        }
        .ab-btn {
            background: var(--bg-light); border: 1px solid var(--border); color: var(--text-sub);
            padding: 5px 12px; border-radius: 4px; cursor: pointer;
            font-size: 12px; font-family: monospace; display: flex; flex-direction: column; align-items: center; min-width: 60px;
        }
        .ab-btn:hover { border-color: var(--text-main); color: var(--text-main); }
        .ab-btn.set { border-color: var(--loop-color); color: var(--loop-color); background: rgba(247, 129, 102, 0.1); }
        .ab-btn span { font-size: 10px; color: #666; margin-top: 2px;}

        .btn-circle {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer; background: white; color: black; transition: transform 0.2s;
        }
        .btn-circle:hover { transform: scale(1.1); }
        
        .btn-clear { background: transparent; border: none; color: #666; font-size: 18px; cursor: pointer; }
        .btn-clear:hover { color: #ff5555; }

        .player-right { display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        .speed-btn { background: transparent; border: none; color: var(--text-sub); cursor: pointer; font-size: 18px; }
        .speed-val { font-family: monospace; width: 40px; text-align: center; font-size: 14px; }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <h2>Kezel√©s</h2>
            <button class="sidebar-btn primary" onclick="createNewGroup()">+ √öj Csoport</button>
            
            <h2 style="margin-top:20px;">Lista</h2>
            <div style="flex-grow: 1; overflow-y: auto; margin-top:5px;" id="group-list"></div>

            <div style="border-top: 1px solid var(--border); padding-top: 15px; margin-top: 10px;">
                <h2>Felh≈ë Szinkron (GitHub)</h2>
                <div id="github-auth-area">
                    <button class="sidebar-btn" onclick="setupGitHub()">üîë Token Be√°ll√≠t√°sa</button>
                </div>
                
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="sidebar-btn" onclick="loadFromGitHub()" title="Bet√∂lt√©s GitHubr√≥l">‚òÅÔ∏è Bet√∂lt</button>
                    <button class="sidebar-btn" onclick="saveToGitHub(false)" title="Ment√©s GitHubra">üíæ Ment√©s</button>
                </div>
                <div id="sync-status" class="sync-status">Szinkroniz√°ci√≥ra v√°r</div>
                <div style="font-size: 10px; color: #555; text-align: center; margin-top:5px;">AutoSave: 5 perc & Kil√©p√©skor</div>
            </div>
        </div>

        <div class="content-area">
            <div id="video-wrapper" class="video-container">
                <div id="player"></div>
            </div>

            <div class="header-controls">
                <h1 id="current-group-title" style="margin:0; font-size: 22px;">K√∂nyvt√°r</h1>
            </div>

            <div class="import-area">
                <textarea id="import-url" rows="1" placeholder="Illessz be egy vagy t√∂bb YouTube linket (soronk√©nt)..."></textarea>
                <button class="sidebar-btn primary" style="width: auto; margin:0; height: 42px;" onclick="addVideosBulk()">Hozz√°ad</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th>Vide√≥ C√≠me</th>
                        <th style="width: 140px; text-align:right;">Kezel√©s</th>
                    </tr>
                </thead>
                <tbody id="video-list-body"></tbody>
            </table>
        </div>
    </div>

    <div class="player-bar">
        <div class="video-info">
            <div class="video-title" id="now-playing-title">Nincs vide√≥</div>
            <div class="video-time" id="time-display">00:00 / 00:00</div>
        </div>
        <div class="player-center">
            <div class="timeline-container" id="timeline" onclick="seekClick(event)">
                <div class="loop-region" id="loop-region" style="left: 0%; width: 0%; display:none;"></div>
                <div class="play-progress" id="play-progress"></div>
            </div>
            <div class="ab-controls">
                <button class="ab-btn" id="btn-a" onclick="setA()">SET A<span id="label-a">--:--</span></button>
                <button class="ab-btn" id="btn-b" onclick="setB()">SET B<span id="label-b">--:--</span></button>
                <button class="btn-clear" onclick="clearLoop()" title="Loop T√∂rl√©se">‚úï</button>
                <div style="width: 1px; height: 20px; background: #444; margin: 0 10px;"></div>
                <button class="speed-btn" onclick="skip(-5)">‚Ü∫</button>
                <button class="btn-circle" onclick="togglePlay()"><span id="play-icon">‚ñ∂</span></button>
                <button class="speed-btn" onclick="skip(5)">‚Üª</button>
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">
                <label><input type="checkbox" id="chk-loop" checked> Auto Loop</label>
            </div>
        </div>
        <div class="player-right">
            <button class="speed-btn" onclick="changeSpeed(-0.1)">-</button>
            <span class="speed-val" id="speed-val">1.0</span>
            <button class="speed-btn" onclick="changeSpeed(0.1)">+</button>
        </div>
    </div>

    <script>
        // --- KONFIGUR√ÅCI√ì ---
        const REPO_OWNER = "Numm1th0r";
        const REPO_NAME = "numm1th0r.github.io";
        const FILE_PATH = "saves.txt";

        // --- Adatstrukt√∫ra ---
        let groups = [ { id: 1, name: 'Kezd≈ë Lista', videos: [] } ];
        let currentGroupId = 1;
        let player, duration = 0, loopStart = null, loopEnd = null, updateInterval;
        let ghToken = localStorage.getItem("yt_looper_gh_token");
        
        // Caching a gyors ment√©shez
        let latestSha = null;

        window.onload = function() {
            const localData = localStorage.getItem('yt_looper_data_v5');
            if(localData) { try { groups = JSON.parse(localData); } catch(e) {} }
            renderGroups(); renderVideos();
            if(ghToken) {
                document.getElementById('sync-status').innerText = "GitHub Akt√≠v";
                document.getElementById('sync-status').style.color = "#238636";
                // Els≈ë bet√∂lt√©s, hogy meglegyen az SHA
                loadFromGitHub(true); 
            }

            // ID≈êZ√çT≈ê: 5 percenk√©nt ment√©s (5 * 60 * 1000 ms)
            setInterval(() => {
                if(ghToken) {
                    saveToGitHub(true); // Csendes ment√©s
                }
            }, 300000);
        };

        // KIL√âP√âS ESEM√âNY (Save on Exit)
        window.addEventListener('beforeunload', (event) => {
            // Helyi ment√©s mindig
            saveToLocalStorage();
            // GitHub ment√©s ha lehets√©ges (keepalive)
            if(ghToken) {
                saveToGitHub(true);
            }
        });

        // --- GITHUB SYNC ---
        function setupGitHub() {
            const token = prompt("GitHub Token:");
            if(token) {
                ghToken = token; localStorage.setItem("yt_looper_gh_token", token);
                document.getElementById('sync-status').innerText = "GitHub Akt√≠v";
                document.getElementById('sync-status').style.color = "#238636";
                alert("Token elmentve! Mostant√≥l m≈±k√∂dik az AutoSave.");
                loadFromGitHub(true); // Azonnali szinkron
            }
        }

        async function loadFromGitHub(silent = false) {
            if(!ghToken) return silent ? null : setupGitHub();
            if(!silent) setStatus("Bet√∂lt√©s...", "orange");
            try {
                const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?t=${Date.now()}`;
                const response = await fetch(url, { headers: { 'Authorization': `token ${ghToken}` } });
                if(!response.ok) throw new Error("Hiba");
                
                const data = await response.json();
                latestSha = data.sha; // SHA elment√©se k√©s≈ëbbi gyors ment√©shez

                const content = decodeURIComponent(escape(window.atob(data.content)));
                groups = JSON.parse(content);
                
                saveToLocalStorage(); 
                renderGroups(); renderVideos();
                if(!silent) setStatus("‚úÖ Bet√∂ltve!", "#238636");
            } catch (err) { 
                if(!silent) { setStatus("‚ùå Hiba!", "red"); alert("Bet√∂lt√©si hiba!"); }
            }
        }

        async function saveToGitHub(silent = false) {
            if(!ghToken) return silent ? null : setupGitHub();
            if(!silent) setStatus("Ment√©s...", "orange");

            try {
                const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
                
                // Ha nincs meg a legut√≥bbi SHA, le kell k√©rni (kiv√©ve ha kil√©p√©s van, ott nem tudunk v√°rni)
                if(!latestSha) {
                     try {
                        const getRes = await fetch(apiUrl, { headers: { 'Authorization': `token ${ghToken}` } });
                        if(getRes.ok) { const getData = await getRes.json(); latestSha = getData.sha; }
                    } catch(e) {}
                }

                const contentStr = JSON.stringify(groups, null, 2);
                const contentBase64 = window.btoa(unescape(encodeURIComponent(contentStr)));
                
                const body = { 
                    message: "AutoSave via TubeLooper", 
                    content: contentBase64 
                };
                if(latestSha) body.sha = latestSha;

                // FONTOS: keepalive: true, hogy kil√©p√©skor is lefusson
                const putRes = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${ghToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    keepalive: true 
                });

                if(!putRes.ok) throw new Error("Hiba");
                
                // Sikeres ment√©s ut√°n friss√≠tj√ºk az SHA-t a v√°laszb√≥l
                const respData = await putRes.json();
                latestSha = respData.content.sha;

                if(silent) {
                    // Csendes visszajelz√©s csak a st√°tuszsoron
                    const now = new Date();
                    const timeStr = now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
                    setStatus(`‚úÖ AutoSave: ${timeStr}`, "#238636");
                } else {
                    setStatus("‚úÖ Mentve!", "#238636");
                }

            } catch (err) { 
                setStatus("‚ùå Ment√©si hiba!", "red"); 
                console.error(err);
            }
        }
        
        function setStatus(msg, color) { 
            const el = document.getElementById('sync-status');
            el.innerText = msg; 
            if(color) el.style.color = color;
        }

        // --- BULK ADD ---
        async function addVideosBulk() {
            const input = document.getElementById('import-url');
            const text = input.value; if (!text.trim()) return;
            const lines = text.split(/\r?\n/);
            const group = groups.find(g => g.id === currentGroupId);
            const videosToFetch = [];

            for (const line of lines) {
                const id = extractVideoID(line);
                if (id) {
                    const newVideo = { id: id, title: "C√≠m bet√∂lt√©se...", addedAt: Date.now() + Math.random() };
                    group.videos.push(newVideo);
                    videosToFetch.push({ videoObj: newVideo, url: line });
                }
            }
            input.value = ''; saveToLocalStorage(); renderVideos();

            for (const item of videosToFetch) {
                const realTitle = await fetchVideoTitle(item.url);
                if (realTitle) {
                    item.videoObj.title = realTitle; renderVideos(); 
                } else {
                    item.videoObj.title = `Vide√≥ (${item.videoObj.id})`; renderVideos();
                }
            }
            saveToLocalStorage();
        }

        async function fetchVideoTitle(url) {
            try { const response = await fetch(`https://noembed.com/embed?url=${url}`); const data = await response.json(); return data.title || null; } catch (error) { return null; }
        }

        // --- PLAYER LOGIC ---
        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerReady(event) { updateInterval = setInterval(loopLogic, 100); }
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                document.getElementById('play-icon').innerHTML = "‚ùö‚ùö"; document.getElementById('video-wrapper').style.display = "block";
                duration = player.getDuration(); tryUpdateCurrentVideoTitle();
            } else { document.getElementById('play-icon').innerHTML = "‚ñ∂"; }
        }
        function loopLogic() {
            if (!player || !player.getCurrentTime) return;
            const ct = player.getCurrentTime();
            if(duration > 0) {
                document.getElementById('time-display').innerText = formatTime(ct) + " / " + formatTime(duration);
                document.getElementById('play-progress').style.width = ((ct / duration) * 100) + "%";
            }
            if (document.getElementById('chk-loop').checked && loopStart !== null && loopEnd !== null) {
                if (ct >= loopEnd || (ct < loopStart && Math.abs(ct-loopStart) > 2)) player.seekTo(loopStart);
            }
        }
        function tryUpdateCurrentVideoTitle() {
            if(!player || !player.getVideoData) return;
            const data = player.getVideoData();
            if(data && data.title) {
                const group = groups.find(g => g.id === currentGroupId);
                const vid = group.videos.find(v => v.id === data.video_id);
                if(vid && (vid.title.includes('Vide√≥ (') || vid.title === 'C√≠m bet√∂lt√©se...')) {
                    vid.title = data.title; saveToLocalStorage(); renderVideos(); document.getElementById('now-playing-title').innerText = data.title;
                }
            }
        }

        // --- CORE FUNCTIONS ---
        function setA() { if(!player) return; loopStart = player.getCurrentTime(); updateLoopVisuals(); }
        function setB() { if(!player) return; loopEnd = player.getCurrentTime(); if (loopStart !== null && loopEnd < loopStart) loopStart = 0; updateLoopVisuals(); }
        function clearLoop() { loopStart = null; loopEnd = null; updateLoopVisuals(); }
        function updateLoopVisuals() {
            const region = document.getElementById('loop-region');
            const btnA = document.getElementById('btn-a'); const lblA = document.getElementById('label-a');
            const btnB = document.getElementById('btn-b'); const lblB = document.getElementById('label-b');
            if (loopStart !== null) { btnA.classList.add('set'); lblA.innerText = formatTime(loopStart); } else { btnA.classList.remove('set'); lblA.innerText = "--:--"; }
            if (loopEnd !== null) { btnB.classList.add('set'); lblB.innerText = formatTime(loopEnd); } else { btnB.classList.remove('set'); lblB.innerText = "--:--"; }
            if (loopStart !== null && loopEnd !== null && duration > 0) {
                region.style.display = "block"; region.style.left = (loopStart/duration)*100 + "%"; region.style.width = ((loopEnd-loopStart)/duration)*100 + "%";
            } else { region.style.display = "none"; }
        }
        function playVideo(id, title) { player.loadVideoById(id); document.getElementById('now-playing-title').innerText = title; clearLoop(); }
        function seekClick(e) { if (!player || duration === 0) return; const rect = e.currentTarget.getBoundingClientRect(); player.seekTo(((e.clientX - rect.left) / rect.width) * duration); }
        function deleteVideo(idx) { if(confirm("T√∂rl√∂d a vide√≥t?")) { groups.find(g => g.id === currentGroupId).videos.splice(idx, 1); saveToLocalStorage(); renderVideos(); } }
        function createNewGroup() { const name = prompt("Csoport neve:"); if(name) { groups.push({ id: Date.now(), name: name, videos: [] }); saveToLocalStorage(); renderGroups(); } }
        function renderGroups() {
            const list = document.getElementById('group-list'); list.innerHTML = '';
            groups.forEach(g => {
                const div = document.createElement('div'); div.className = `group-item ${g.id === currentGroupId ? 'active' : ''}`; div.innerText = g.name;
                div.onclick = () => { currentGroupId = g.id; renderGroups(); renderVideos(); }; list.appendChild(div);
            });
            document.getElementById('current-group-title').innerText = groups.find(g => g.id === currentGroupId)?.name || 'K√∂nyvt√°r';
        }
        function renderVideos() {
            const tbody = document.getElementById('video-list-body'); tbody.innerHTML = '';
            const group = groups.find(g => g.id === currentGroupId); if(!group) return;
            group.videos.forEach((vid, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="color:#666">${idx+1}</td><td>${vid.title}</td><td style="text-align:right;"><button class="action-btn" onclick="playVideo('${vid.id}', '${vid.title.replace(/'/g, "\\'")}')">Lej√°tsz√°s</button> <button class="action-btn btn-delete" onclick="deleteVideo(${idx})">T√∂rl√©s</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function saveToLocalStorage() { localStorage.setItem('yt_looper_data_v5', JSON.stringify(groups)); }
        function extractVideoID(url) { var match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); return (match && match[2].length == 11) ? match[2] : null; }
        function formatTime(s) { if(isNaN(s)) return "00:00"; const m = Math.floor(s/60), sec = Math.floor(s%60); return (m<10?"0"+m:m) + ":" + (sec<10?"0"+sec:sec); }
        function changeSpeed(d) { let n = Math.round((Math.max(0.25, Math.min(2.0, player.getPlaybackRate() + d)))*100)/100; player.setPlaybackRate(n); document.getElementById('speed-val').innerText = n; }
        function skip(s) { player.seekTo(player.getCurrentTime() + s); }
        function togglePlay() { if(player.getPlayerState()===1) player.pauseVideo(); else player.playVideo(); }
    </script>
</body>
</html>
