<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT Looper & Manager</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #181818;
            --bg-light: #282828;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --accent: #1db954; /* Spotify zöld */
            --loop-color: #ff4081; /* A képen lévő pinkes szín */
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: grid;
            grid-template-rows: 1fr 140px; /* Tartalom és Lejátszó sáv */
            overflow: hidden;
        }

        /* --- Fő elrendezés --- */
        .main-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            overflow: hidden;
        }

        /* --- Oldalsáv (Csoportok) --- */
        .sidebar {
            background-color: black;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid #333;
        }

        .sidebar h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-sub); margin-bottom: 10px; }
        
        .group-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-sub);
            transition: 0.2s;
        }
        .group-item:hover, .group-item.active { background-color: var(--bg-light); color: white; }
        
        .add-btn {
            background: transparent; border: 1px solid var(--text-sub); color: var(--text-main);
            padding: 8px; cursor: pointer; border-radius: 20px; margin-top: auto;
        }

        /* --- Lista nézet --- */
        .content-area {
            background: linear-gradient(to bottom, #303030, #121212);
            padding: 30px;
            overflow-y: auto;
        }

        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .import-area textarea {
            width: 100%; height: 60px; background: var(--bg-light); border: none; color: white; padding: 10px;
            margin-bottom: 10px; resize: none; border-radius: 4px;
        }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: var(--text-sub); border-bottom: 1px solid #333; padding: 10px; font-weight: normal;}
        td { padding: 10px; border-bottom: 1px solid #222; }
        tr:hover { background-color: rgba(255,255,255,0.1); }
        
        .play-row-btn {
            background: transparent; border: none; color: white; cursor: pointer; font-size: 16px;
        }
        .play-row-btn:hover { color: var(--accent); }

        /* --- Lejátszó sáv (Alsó rész - A KÉP ALAPJÁN) --- */
        .player-bar {
            background-color: var(--bg-panel);
            border-top: 1px solid #333;
            padding: 10px 20px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            position: relative;
        }

        /* Bal oldal: Videó infó */
        .video-info { font-size: 14px; }
        .video-title { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }

        /* Közép: Kontrollok és Timeline */
        .player-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        /* Az egyedi Loop Timeline */
        .timeline-container {
            width: 100%;
            height: 40px;
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            user-select: none;
        }

        .track-bg {
            position: absolute; width: 100%; height: 4px; background: #535353; border-radius: 2px;
        }

        /* A loopolt szakasz (Piros/Pink) */
        .loop-region {
            position: absolute; height: 4px; background: var(--loop-color);
            left: 0%; width: 100%; /* JS fogja állítani */
            z-index: 1;
        }

        /* Fehér négyzet fogantyúk */
        .handle {
            width: 14px; height: 14px; background: white; position: absolute; top: 50%;
            transform: translate(-50%, -50%); cursor: col-resize; z-index: 3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* Jelenlegi pozíció jelző (kis vonal) */
        .playhead {
            width: 2px; height: 12px; background: white; position: absolute; top: 50%;
            transform: translate(-50%, -50%); z-index: 2; pointer-events: none;
        }

        /* Időcímkék a csúszka felett */
        .time-label {
            position: absolute; top: -20px; font-size: 12px; color: white; transform: translateX(-50%);
        }

        /* Gombok (Kör alakúak a kép alapján) */
        .controls { display: flex; gap: 20px; align-items: center; }
        
        .btn-control {
            background: transparent; border: none; color: #b3b3b3; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-control:hover { color: white; }

        .btn-circle {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; transition: 0.2s;
        }
        
        .btn-play { background: white; color: black; }
        .btn-play:hover { transform: scale(1.05); }

        .btn-loop {
            background: linear-gradient(135deg, #ff4081, #d81b60); 
            color: white; 
        }
        .btn-loop.inactive { background: #333; color: #777; }

        /* Jobb oldal: Sebesség */
        .player-right { display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .speed-display { font-size: 14px; width: 40px; text-align: center; }

        /* Rejtett YouTube iframe */
        #yt-player-container { position: absolute; top: -9999px; visibility: hidden; }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <h2>Könyvtár</h2>
            <div id="group-list">
                </div>
            <button class="add-btn" onclick="createNewGroup()">+ Új Csoport</button>
        </div>

        <div class="content-area">
            <div class="header-controls">
                <h1 id="current-group-title">Minden Videó</h1>
            </div>

            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top:0; font-size:14px;">Videók hozzáadása (Youtube linkek)</h3>
                <div class="import-area">
                    <textarea id="import-text" placeholder="Illessz be ide YouTube linkeket (soronként egyet)..."></textarea>
                    <button onclick="importVideos()" style="background:var(--accent); border:none; padding:8px 16px; color:white; border-radius:20px; cursor:pointer; font-weight:bold;">Hozzáadás</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Cím</th>
                        <th>ID</th>
                        <th>Művelet</th>
                    </tr>
                </thead>
                <tbody id="video-list-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="player-bar">
        <div class="video-info">
            <strong class="video-title" id="now-playing-title">Nincs videó kiválasztva</strong>
            <span id="now-playing-time">0:00 / 0:00</span>
        </div>

        <div class="player-center">
            <div class="timeline-container" id="timeline">
                <div class="track-bg"></div>
                <div class="loop-region" id="loop-region" style="left: 0%; width: 100%;"></div>
                <div class="handle" id="handle-start" style="left: 0%;"></div>
                <div class="handle" id="handle-end" style="left: 100%;"></div>
                <div class="playhead" id="playhead" style="left: 0%;"></div>
                
                <div class="time-label" id="label-start" style="left: 0%;">00:00</div>
                <div class="time-label" id="label-end" style="left: 100%;">00:00</div>
            </div>

            <div class="controls">
                <button class="btn-control" onclick="skip(-5)">↺</button>
                
                <button class="btn-circle btn-loop" id="loop-toggle-btn" onclick="toggleLoopMode()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 1l4 4-4 4"></path>
                        <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                        <path d="M7 23l-4-4 4-4"></path>
                        <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                    </svg>
                </button>

                <button class="btn-circle btn-play" onclick="togglePlay()">
                    <span id="play-icon">▶</span>
                </button>

                <button class="btn-control" onclick="skip(5)">↻</button>
            </div>
        </div>

        <div class="player-right">
            <button class="btn-control" onclick="changeSpeed(-0.25)">-</button>
            <span class="speed-display" id="speed-val">1.0x</span>
            <button class="btn-control" onclick="changeSpeed(0.25)">+</button>
        </div>
    </div>

    <div id="yt-player-container">
        <div id="player"></div>
    </div>

    <script>
        // --- Adatstruktúra ---
        let groups = [
            { id: 1, name: 'Kedvencek', videos: [] },
            { id: 2, name: 'Gitár Gyakorlás', videos: [] }
        ];
        let currentGroupId = 1;
        let player; // YouTube Player objektum
        let intervalId; // Loop ellenőrzéshez
        
        // --- Állapotváltozók ---
        let currentVideoDuration = 0;
        let isLooping = true;
        let loopStart = 0; // másodpercben
        let loopEnd = 100; // másodpercben
        let isDragging = null; // 'start', 'end', vagy null

        // --- YouTube API Betöltése ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: '',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            updateTimeline();
            setInterval(loopCheck, 100); // Rendszeresen ellenőrizzük a pozíciót
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                document.getElementById('play-icon').innerHTML = "❚❚";
                currentVideoDuration = player.getDuration();
                // Ha új videó, reseteljük a loop vége markert a végére
                // (Itt most egyszerűsítésképpen nem reseteljük mindig, hogy megmaradjon a beállítás szerkesztésnél)
            } else {
                document.getElementById('play-icon').innerHTML = "▶";
            }
        }

        // --- Loop Logika ---
        function loopCheck() {
            if (!player || !player.getCurrentTime) return;

            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            
            if(duration > 0 && currentVideoDuration !== duration) {
                currentVideoDuration = duration;
                // Inicializáláskor a loop vége legyen a videó vége, ha még nincs beállítva
                if(loopEnd === 100) loopEnd = duration; 
            }

            // UI Frissítése (Playhead)
            if(duration > 0) {
                const percent = (currentTime / duration) * 100;
                document.getElementById('playhead').style.left = percent + '%';
                
                // Időkijelzés
                document.getElementById('now-playing-time').innerText = 
                    formatTime(currentTime) + " / " + formatTime(duration);
            }

            // Loop működése
            if (isLooping && duration > 0) {
                if (currentTime >= loopEnd || currentTime < loopStart - 1) {
                    player.seekTo(loopStart);
                }
            }
        }

        // --- Felület kezelés (Renderelés) ---
        function renderGroups() {
            const list = document.getElementById('group-list');
            list.innerHTML = '';
            groups.forEach(g => {
                const div = document.createElement('div');
                div.className = `group-item ${g.id === currentGroupId ? 'active' : ''}`;
                div.innerText = g.name;
                div.onclick = () => { currentGroupId = g.id; renderGroups(); renderVideos(); };
                list.appendChild(div);
            });
            const activeGroup = groups.find(g => g.id === currentGroupId);
            document.getElementById('current-group-title').innerText = activeGroup ? activeGroup.name : 'Válassz csoportot';
        }

        function renderVideos() {
            const tbody = document.getElementById('video-list-body');
            tbody.innerHTML = '';
            const group = groups.find(g => g.id === currentGroupId);
            if (!group) return;

            group.videos.forEach((vid, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${vid.title || 'Betöltés...'}</td>
                    <td style="color:#666; font-family:monospace;">${vid.id}</td>
                    <td>
                        <button class="play-row-btn" onclick="playVideo('${vid.id}', '${vid.title}')">▶ Lejátszás</button>
                        <button class="play-row-btn" style="color:#ff4081; font-size:12px; margin-left:10px;" onclick="deleteVideo(${index})">✕</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Adatkezelés ---
        function createNewGroup() {
            const name = prompt("Mi legyen a csoport neve?");
            if (name) {
                groups.push({ id: Date.now(), name: name, videos: [] });
                renderGroups();
            }
        }

        function importVideos() {
            const text = document.getElementById('import-text').value;
            const lines = text.split('\n');
            const group = groups.find(g => g.id === currentGroupId);
            
            lines.forEach(line => {
                const id = extractVideoID(line);
                if (id) {
                    group.videos.push({ id: id, title: 'YouTube Videó (' + id + ')', start: 0, end: 0 });
                }
            });
            
            document.getElementById('import-text').value = '';
            renderVideos();
            // Opcionális: Címek lekérdezése YT API-n keresztül itt bonyolult lenne backend nélkül, 
            // így most placeholdert használunk.
        }

        function deleteVideo(index) {
            const group = groups.find(g => g.id === currentGroupId);
            group.videos.splice(index, 1);
            renderVideos();
        }

        function extractVideoID(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            if (match && match[2].length == 11) {
                return match[2];
            } else {
                return null;
            }
        }

        // --- Lejátszó Vezérlés ---
        function playVideo(id, title) {
            player.loadVideoById(id);
            document.getElementById('now-playing-title').innerText = title;
            // Alaphelyzetbe állítjuk a loop csúszkákat (teljes hosszra, majd frissül ha betölt)
            loopStart = 0;
            loopEnd = 10000; // Majd beáll a valódi hosszra
            updateTimelineVisuals();
        }

        function togglePlay() {
            if (player.getPlayerState() == YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function toggleLoopMode() {
            isLooping = !isLooping;
            const btn = document.getElementById('loop-toggle-btn');
            if(isLooping) {
                btn.classList.remove('inactive');
                document.getElementById('loop-region').style.opacity = '1';
            } else {
                btn.classList.add('inactive');
                document.getElementById('loop-region').style.opacity = '0.3';
            }
        }

        function changeSpeed(delta) {
            let rate = player.getPlaybackRate();
            let newRate = Math.max(0.25, Math.min(2.0, rate + delta));
            player.setPlaybackRate(newRate);
            document.getElementById('speed-val').innerText = newRate + "x";
        }

        function skip(sec) {
            const curr = player.getCurrentTime();
            player.seekTo(curr + sec);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return (mins < 10 ? "0" + mins : mins) + ":" + (secs < 10 ? "0" + secs : secs);
        }

        // --- Timeline Slider Logika (DRAG & DROP) ---
        const timeline = document.getElementById('timeline');
        
        timeline.addEventListener('mousedown', (e) => {
            const rect = timeline.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            const percent = x / width;
            
            // Eldöntjük melyikhez van közelebb
            const startPos = loopStart / currentVideoDuration;
            const endPos = loopEnd / currentVideoDuration;
            
            const distStart = Math.abs(percent - startPos);
            const distEnd = Math.abs(percent - endPos);

            if (distStart < 0.05) isDragging = 'start';
            else if (distEnd < 0.05) isDragging = 'end';
            else {
                // Ha csak a timeline-ra kattint, ugorjon oda a videó
                if(currentVideoDuration > 0) {
                    player.seekTo(percent * currentVideoDuration);
                }
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging || currentVideoDuration <= 0) return;
            
            const rect = timeline.getBoundingClientRect();
            let x = e.clientX - rect.left;
            // Határok
            if(x < 0) x = 0;
            if(x > rect.width) x = rect.width;
            
            const time = (x / rect.width) * currentVideoDuration;

            if (isDragging === 'start') {
                if (time < loopEnd) loopStart = time;
            } else if (isDragging === 'end') {
                if (time > loopStart) loopEnd = time;
            }
            updateTimelineVisuals();
        });

        document.addEventListener('mouseup', () => {
            if(isDragging) {
                // Ha végeztünk a húzással, ugorjunk a loop elejére, ha 'start'-ot húztuk
                if(isDragging === 'start') player.seekTo(loopStart);
                isDragging = null;
            }
        });

        function updateTimelineVisuals() {
            if (currentVideoDuration <= 0) return;

            const startP = (loopStart / currentVideoDuration) * 100;
            const endP = (loopEnd / currentVideoDuration) * 100;

            document.getElementById('handle-start').style.left = startP + '%';
            document.getElementById('handle-end').style.left = endP + '%';
            
            const region = document.getElementById('loop-region');
            region.style.left = startP + '%';
            region.style.width = (endP - startP) + '%';

            document.getElementById('label-start').style.left = startP + '%';
            document.getElementById('label-start').innerText = formatTime(loopStart);

            document.getElementById('label-end').style.left = endP + '%';
            document.getElementById('label-end').innerText = formatTime(loopEnd);
        }

        // Inicializálás
        renderGroups();
    </script>
</body>
</html>
